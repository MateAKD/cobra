#!/bin/bash

# ========================================
# LIMPIEZA PROFUNDA DE MALWARE
# ========================================
# Elimina malware conocido y verifica integridad del sistema

set -e

echo "üßπ =========================================="
echo "üßπ LIMPIEZA PROFUNDA DE MALWARE"
echo "üßπ =========================================="
echo ""

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() { echo -e "${GREEN}[$(date '+%H:%M:%S')]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }
warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }

# Variables
MALWARE_LOG="/var/log/malware-cleanup-$(date +%Y%m%d-%H%M%S).log"
QUARANTINE_DIR="/var/quarantine/$(date +%Y%m%d-%H%M%S)"

# Crear directorio de cuarentena
sudo mkdir -p "$QUARANTINE_DIR"

# ========================================
# 1. DETENER PROCESOS MALICIOSOS
# ========================================
log "üõë Deteniendo procesos maliciosos..."

MALICIOUS_NAMES=(
    "hash"
    "kdevtmpfsi"
    "kinsing"
    "xmrig"
    "xmr-stak"
    "cpuminer"
    "minerd"
    "ccminer"
    "ethminer"
    "cryptonight"
    ".rsync"
    "bioset"
    "networkservice"
)

for proc in "${MALICIOUS_NAMES[@]}"; do
    if pgrep -x "$proc" > /dev/null; then
        warning "   Encontrado proceso: $proc"
        sudo pkill -9 "$proc" 2>/dev/null || true
        echo "   [$(date)] Proceso eliminado: $proc" >> "$MALWARE_LOG"
    fi
done

# Buscar procesos con alto CPU (posibles mineros)
log "üîç Buscando procesos con alto CPU..."
HIGH_CPU_PROCS=$(ps aux --sort=-%cpu | head -10 | awk '{if(NR>1 && $3>50) print $2,$11}')
if [ ! -z "$HIGH_CPU_PROCS" ]; then
    warning "   Procesos con CPU >50%:"
    echo "$HIGH_CPU_PROCS"
    echo "$HIGH_CPU_PROCS" >> "$MALWARE_LOG"
fi

# ========================================
# 2. BUSCAR Y ELIMINAR ARCHIVOS MALICIOSOS
# ========================================
log "üîç Buscando archivos maliciosos..."

# Directorios comunes de malware
SEARCH_DIRS=(
    "/tmp"
    "/var/tmp"
    "/dev/shm"
    "/var/www"
    "/home"
    "/root"
    "/opt"
)

# Nombres de archivos maliciosos conocidos
MALICIOUS_FILES=(
    "hash"
    "kdevtmpfsi"
    "kinsing"
    "xmrig"
    ".rsync"
    "bioset"
    "networkservice"
    "masscan"
    "pnscan"
)

for dir in "${SEARCH_DIRS[@]}"; do
    if [ -d "$dir" ]; then
        log "   Escaneando $dir..."
        for malfile in "${MALICIOUS_FILES[@]}"; do
            # Buscar archivos exactos
            sudo find "$dir" -type f -name "$malfile" 2>/dev/null | while read -r file; do
                warning "   ‚ö†Ô∏è  Archivo malicioso encontrado: $file"
                
                # Mover a cuarentena
                sudo mv "$file" "$QUARANTINE_DIR/" 2>/dev/null || sudo rm -f "$file"
                echo "[$(date)] Archivo en cuarentena: $file" >> "$MALWARE_LOG"
            done
        done
    fi
done

# Buscar archivos ejecutables sospechosos en /tmp
log "üîç Buscando ejecutables sospechosos en /tmp..."
sudo find /tmp /var/tmp /dev/shm -type f -executable 2>/dev/null | while read -r file; do
    # Verificar si es binario ELF
    if file "$file" | grep -q "ELF"; then
        warning "   Ejecutable sospechoso: $file"
        echo "[$(date)] Ejecutable sospechoso: $file" >> "$MALWARE_LOG"
        
        # Mover a cuarentena
        sudo mv "$file" "$QUARANTINE_DIR/" 2>/dev/null || true
    fi
done

# ========================================
# 3. VERIFICAR CRON JOBS MALICIOSOS
# ========================================
log "üîç Verificando cron jobs..."

# Verificar crontabs de usuarios
for user in $(cut -f1 -d: /etc/passwd); do
    CRON_CONTENT=$(sudo crontab -u "$user" -l 2>/dev/null || true)
    if [ ! -z "$CRON_CONTENT" ]; then
        # Buscar patrones sospechosos
        if echo "$CRON_CONTENT" | grep -qE "curl|wget|/tmp|/dev/shm|base64|eval"; then
            warning "   ‚ö†Ô∏è  Crontab sospechoso para usuario: $user"
            echo "$CRON_CONTENT" >> "$MALWARE_LOG"
            echo "---" >> "$MALWARE_LOG"
        fi
    fi
done

# Verificar archivos cron del sistema
CRON_DIRS=(
    "/etc/cron.d"
    "/etc/cron.daily"
    "/etc/cron.hourly"
    "/etc/cron.weekly"
    "/etc/cron.monthly"
)

for crondir in "${CRON_DIRS[@]}"; do
    if [ -d "$crondir" ]; then
        sudo grep -r -E "curl|wget|/tmp|base64" "$crondir" 2>/dev/null | while read -r line; do
            warning "   ‚ö†Ô∏è  Cron sospechoso: $line"
            echo "$line" >> "$MALWARE_LOG"
        done
    fi
done

# ========================================
# 4. VERIFICAR SERVICIOS SYSTEMD SOSPECHOSOS
# ========================================
log "üîç Verificando servicios systemd..."

# Buscar servicios que ejecuten desde /tmp o /dev/shm
sudo systemctl list-units --type=service --all | grep -E "tmp|shm" | while read -r service; do
    warning "   ‚ö†Ô∏è  Servicio sospechoso: $service"
    echo "$service" >> "$MALWARE_LOG"
done

# ========================================
# 5. VERIFICAR CONEXIONES DE RED SOSPECHOSAS
# ========================================
log "üîç Verificando conexiones de red..."

# Puertos comunes de mining pools
MINING_PORTS=(3333 4444 5555 7777 8888 14444 45560)

for port in "${MINING_PORTS[@]}"; do
    CONNECTIONS=$(sudo netstat -tulpn 2>/dev/null | grep ":$port" || true)
    if [ ! -z "$CONNECTIONS" ]; then
        warning "   ‚ö†Ô∏è  Conexi√≥n a puerto de mining ($port):"
        echo "$CONNECTIONS"
        echo "[$(date)] Conexi√≥n sospechosa: $CONNECTIONS" >> "$MALWARE_LOG"
    fi
done

# Verificar conexiones establecidas a IPs externas
log "üîç Conexiones externas activas:"
sudo netstat -tupn 2>/dev/null | grep ESTABLISHED | grep -v "127.0.0.1" | grep -v "::1" | head -10

# ========================================
# 6. VERIFICAR ARCHIVOS MODIFICADOS RECIENTEMENTE
# ========================================
log "üîç Archivos modificados en las √∫ltimas 24 horas..."

# Buscar en directorios cr√≠ticos
sudo find /var/www /tmp /var/tmp /dev/shm -type f -mtime -1 2>/dev/null | head -20 | while read -r file; do
    echo "   $file"
done

# ========================================
# 7. LIMPIAR DIRECTORIOS TEMPORALES
# ========================================
log "üßπ Limpiando directorios temporales..."

# Limpiar /tmp (excepto archivos del sistema)
sudo find /tmp -type f -mtime +1 -delete 2>/dev/null || true
sudo find /var/tmp -type f -mtime +1 -delete 2>/dev/null || true

# Limpiar /dev/shm
sudo rm -rf /dev/shm/* 2>/dev/null || true

# ========================================
# 8. VERIFICAR INTEGRIDAD DE ARCHIVOS DEL SISTEMA
# ========================================
log "üîç Verificando integridad de archivos cr√≠ticos..."

# Verificar /etc/passwd y /etc/shadow
if sudo grep -E ":\$|::|:0:" /etc/passwd; then
    error "   ‚ö†Ô∏è  Entradas sospechosas en /etc/passwd"
fi

# Verificar usuarios con UID 0 (root)
ROOT_USERS=$(sudo awk -F: '$3 == 0 {print $1}' /etc/passwd)
if [ "$ROOT_USERS" != "root" ]; then
    warning "   ‚ö†Ô∏è  Usuarios adicionales con UID 0: $ROOT_USERS"
    echo "[$(date)] Usuarios con UID 0: $ROOT_USERS" >> "$MALWARE_LOG"
fi

# ========================================
# 9. VERIFICAR CLAVES SSH
# ========================================
log "üîç Verificando claves SSH autorizadas..."

for user_home in /home/* /root; do
    AUTH_KEYS="$user_home/.ssh/authorized_keys"
    if [ -f "$AUTH_KEYS" ]; then
        NUM_KEYS=$(wc -l < "$AUTH_KEYS")
        if [ "$NUM_KEYS" -gt 0 ]; then
            echo "   $AUTH_KEYS: $NUM_KEYS claves"
            
            # Buscar claves sospechosas (muy largas o con comentarios raros)
            sudo grep -v "^#" "$AUTH_KEYS" | while read -r key; do
                if echo "$key" | grep -qE "curl|wget|bash|sh"; then
                    warning "   ‚ö†Ô∏è  Clave SSH sospechosa en $AUTH_KEYS"
                    echo "$key" >> "$MALWARE_LOG"
                fi
            done
        fi
    fi
done

# ========================================
# 10. RESUMEN
# ========================================
echo ""
log "‚úÖ =========================================="
log "‚úÖ LIMPIEZA COMPLETADA"
log "‚úÖ =========================================="
echo ""
echo "üìã Log completo: $MALWARE_LOG"
echo "üì¶ Archivos en cuarentena: $QUARANTINE_DIR"
echo ""
warning "‚ö†Ô∏è  PR√ìXIMOS PASOS:"
echo "1. Revisar el log: cat $MALWARE_LOG"
echo "2. Aplicar parches de seguridad: bash security-patch-react2shell.sh"
echo "3. Ejecutar hardening: bash harden-security.sh"
echo "4. Rotar todas las credenciales"
echo "5. Revisar archivos en cuarentena"
echo ""
