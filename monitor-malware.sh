#!/bin/bash
LOG_FILE="/var/log/malware-monitor.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

# 1. Self-Healing: Check if App is running
# If pm2 list doesn't show "online", verify if it's actually down or just not listed properly.
# We trust 'pm2 jlist' returning JSON status 'online'.
if ! pm2 list | grep -q "online"; then
    echo "[$DATE] âš ï¸ App appears down. Attempting restart..." >> "$LOG_FILE"
    export PATH=$PATH:/usr/bin:/usr/local/bin
    pm2 resurrect >> "$LOG_FILE" 2>&1
    pm2 start all >> "$LOG_FILE" 2>&1
fi

# 2. Protection: Kill unknown high-CPU processes (>60%)
# Valid processes: node, mongod, nginx, etc.
ps aux --sort=-%cpu | head -n 3 | awk '{if($3>60) print $0}' | while read line; do
    PID=$(echo "$line" | awk '{print $2}')
    USER=$(echo "$line" | awk '{print $1}')
    CMD=$(echo "$line" | awk '{print $11}')
    
    # Simple whitelist check
    if [[ "$CMD" != *"node"* && "$CMD" != *"npm"* && "$CMD" != *"mongod"* && "$CMD" != *"nginx"* && "$CMD" != *"systemd"* ]]; then
        echo "[$DATE] ðŸš¨ KILLING SUSPICIOUS HIGH-CPU PROCESS: $line" >> "$LOG_FILE"
        kill -9 $PID
    fi
done

# 3. Clean old tmp files to prevent payload accumulation
find /tmp -type f -mtime +7 -delete 2>/dev/null
