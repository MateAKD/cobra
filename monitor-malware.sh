#!/bin/bash

# Monitor de Malware - Cobra 2.0
# Detecta y elimina autom√°ticamente procesos maliciosos

LOG_FILE="/var/log/malware-monitor.log"
ALERT_EMAIL="tmatepedace@gmail.com"

# Funci√≥n para registrar eventos
log_event() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Funci√≥n para enviar alerta
send_alert() {
    # echo "$1" | mail -s "üö® ALERTA MALWARE - $(hostname)" "$ALERT_EMAIL" 2>/dev/null || true
    # Comentado mail para evitar errores si no est√° configurado, solo log
    log_event "ALERTA CR√çTICA: $1"
}

# 1. Verificar procesos maliciosos
MALICIOUS_PROCS=$(ps aux | grep -E "hash|kdevtmpfsi|kinsing|xmrig" | grep -v grep | grep -v monitor)

if [ ! -z "$MALICIOUS_PROCS" ]; then
    log_event "‚ö†Ô∏è PROCESOS MALICIOSOS DETECTADOS"
    echo "$MALICIOUS_PROCS" >> "$LOG_FILE"
    
    # Matar procesos
    sudo pkill -9 hash 2>/dev/null || true
    sudo pkill -9 kdevtmpfsi 2>/dev/null || true
    sudo pkill -9 kinsing 2>/dev/null || true
    sudo pkill -9 xmrig 2>/dev/null || true
    
    send_alert "Procesos maliciosos detectados y eliminados: $MALICIOUS_PROCS"
fi

# 2. Verificar archivos maliciosos en el proyecto
MALICIOUS_FILES=$(find /var/www/cobra -maxdepth 1 -type f -name "hash" -o -name "kdevtmpfsi" -o -name "kinsing" 2>/dev/null)

if [ ! -z "$MALICIOUS_FILES" ]; then
    log_event "‚ö†Ô∏è ARCHIVOS MALICIOSOS DETECTADOS"
    echo "$MALICIOUS_FILES" >> "$LOG_FILE"
    
    # Eliminar archivos
    sudo rm -f /var/www/cobra/hash 2>/dev/null || true
    sudo rm -f /var/www/cobra/kdevtmpfsi 2>/dev/null || true
    sudo rm -f /var/www/cobra/kinsing 2>/dev/null || true
    
    send_alert "Archivos maliciosos detectados y eliminados: $MALICIOUS_FILES"
fi

# 3. Verificar uso de CPU
CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
CPU_THRESHOLD=90

if (( $(echo "$CPU_USAGE > $CPU_THRESHOLD" | bc -l) )); then
    log_event "‚ö†Ô∏è CPU ALTO: ${CPU_USAGE}%"
    
    # Obtener top 5 procesos
    TOP_PROCS=$(ps aux --sort=-%cpu | head -6 | tail -5)
    
    # Verificar si alguno es sospechoso
    SUSPICIOUS=$(echo "$TOP_PROCS" | grep -E "hash|kdevtmpfsi|kinsing|xmrig" | grep -v grep)
    
    if [ ! -z "$SUSPICIOUS" ]; then
        send_alert "CPU al ${CPU_USAGE}% - Procesos sospechosos: $SUSPICIOUS"
    fi
fi

# 4. Verificar conexiones de red sospechosas (puertos de mining)
SUSPICIOUS_PORTS=$(netstat -tulpn 2>/dev/null | grep -E ":3333|:4444|:5555|:7777|:8888|:14444" | grep ESTABLISHED)

if [ ! -z "$SUSPICIOUS_PORTS" ]; then
    log_event "‚ö†Ô∏è CONEXIONES SOSPECHOSAS DETECTADAS"
    echo "$SUSPICIOUS_PORTS" >> "$LOG_FILE"
    send_alert "Conexiones a puertos de mining detectadas: $SUSPICIOUS_PORTS"
fi

# 5. Verificar estado de PM2
PM2_STATUS=$(pm2 status | grep cobra-bar | grep -c online || echo "0")

if [ "$PM2_STATUS" -eq "0" ]; then
    log_event "‚ö†Ô∏è APLICACI√ìN CA√çDA - Reiniciando..."
    # Intenta reiniciar all
    pm2 restart all || pm2 start npm --name "cobra-bar" -- start
    send_alert "Aplicaci√≥n Cobra estaba ca√≠da - Reiniciada autom√°ticamente"
fi

log_event "‚úì Monitoreo completado - Todo OK"
