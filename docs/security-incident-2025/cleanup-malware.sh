#!/bin/bash

# Script de Limpieza de Malware para VPS
# Uso: sudo ./cleanup-malware.sh

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${RED}ðŸ›¡ï¸  INICIANDO LIMPIEZA DE MALWARE${NC}"
echo "================================================"

# 1. Eliminar libprocesshider.so
echo -e "${BLUE}[1/8] Eliminando libprocesshider.so...${NC}"
if [ -f /etc/ld.so.preload ]; then
    echo -e "${YELLOW}Contenido actual de /etc/ld.so.preload:${NC}"
    cat /etc/ld.so.preload
    
    # Hacer backup
    cp /etc/ld.so.preload /etc/ld.so.preload.backup
    
    # Limpiar el archivo
    > /etc/ld.so.preload
    echo -e "${GREEN}âœ“ /etc/ld.so.preload limpiado${NC}"
fi

if [ -f /usr/local/lib/libprocesshider.so ]; then
    rm -f /usr/local/lib/libprocesshider.so
    echo -e "${GREEN}âœ“ libprocesshider.so eliminado${NC}"
fi

# 2. Buscar y eliminar procesos maliciosos conocidos
echo -e "${BLUE}[2/8] Buscando procesos maliciosos...${NC}"
MALWARE_PROCESSES=("xmrig" "kdevtmpfsi" "kinsing" "kthrotlds" "bioset" "watchbog" "crypto" "minerd" "ccminer")

for proc in "${MALWARE_PROCESSES[@]}"; do
    if pgrep -x "$proc" > /dev/null; then
        echo -e "${RED}âš ï¸  Proceso malicioso detectado: $proc${NC}"
        pkill -9 "$proc" || true
        echo -e "${GREEN}âœ“ Proceso $proc eliminado${NC}"
    fi
done

# 3. Buscar procesos con alto uso de CPU
echo -e "${BLUE}[3/8] Procesos con alto uso de CPU:${NC}"
ps aux --sort=-%cpu | head -10

# 4. Limpiar cron jobs sospechosos
echo -e "${BLUE}[4/8] Revisando cron jobs...${NC}"
echo -e "${YELLOW}Crontabs del sistema:${NC}"
cat /etc/crontab 2>/dev/null || echo "No hay crontab del sistema"

echo -e "${YELLOW}Crontabs de usuarios:${NC}"
for user in $(cut -f1 -d: /etc/passwd); do
    crontab -u $user -l 2>/dev/null | grep -v "^#" | grep -v "^$" && echo "Usuario: $user" || true
done

# 5. Buscar archivos maliciosos en ubicaciones comunes
echo -e "${BLUE}[5/8] Buscando archivos maliciosos...${NC}"
MALWARE_PATHS=(
    "/tmp"
    "/var/tmp"
    "/dev/shm"
    "/usr/local/lib"
    "/usr/bin"
    "/usr/sbin"
)

for path in "${MALWARE_PATHS[@]}"; do
    if [ -d "$path" ]; then
        echo -e "${YELLOW}Revisando: $path${NC}"
        find "$path" -type f -name "*xmrig*" -o -name "*kdevtmpfsi*" -o -name "*kinsing*" 2>/dev/null || true
    fi
done

# 6. Revisar conexiones de red sospechosas
echo -e "${BLUE}[6/8] Conexiones de red activas:${NC}"
netstat -tunap 2>/dev/null | grep ESTABLISHED || ss -tunap | grep ESTAB

# 7. Revisar usuarios del sistema
echo -e "${BLUE}[7/8] Usuarios con shell de login:${NC}"
grep -v "/nologin\|/false" /etc/passwd

# 8. Limpiar archivos temporales
echo -e "${BLUE}[8/8] Limpiando archivos temporales...${NC}"
rm -rf /tmp/* /var/tmp/* /dev/shm/* 2>/dev/null || true
echo -e "${GREEN}âœ“ Archivos temporales limpiados${NC}"

echo ""
echo -e "${GREEN}================================================${NC}"
echo -e "${GREEN}âœ… LIMPIEZA COMPLETADA${NC}"
echo ""
echo -e "${YELLOW}PRÃ“XIMOS PASOS RECOMENDADOS:${NC}"
echo "1. Revisa los procesos con alto CPU arriba"
echo "2. Elimina manualmente cualquier cron job sospechoso"
echo "3. Cambia todas las contraseÃ±as (SSH, sudo, etc.)"
echo "4. Considera reinstalar el VPS si la infecciÃ³n es severa"
echo "5. Ejecuta: sudo reboot"
