#!/bin/bash

# Script de Limpieza AVANZADA de Malware para VPS
# Uso: sudo ./cleanup-malware-advanced.sh
# ADVERTENCIA: Este script es m√°s agresivo y puede afectar procesos leg√≠timos

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
NC='\033[0m'

echo -e "${RED}üî• LIMPIEZA AVANZADA DE MALWARE${NC}"
echo "================================================"
echo -e "${YELLOW}ADVERTENCIA: Este script realizar√° cambios agresivos${NC}"
echo "Presiona Ctrl+C en los pr√≥ximos 5 segundos para cancelar..."
sleep 5

# 1. DETENER Y ELIMINAR PROCESOS MALICIOSOS
echo -e "${BLUE}[1/15] Eliminando procesos maliciosos conocidos...${NC}"

# Lista extendida de malware conocido
MALWARE_PROCESSES=(
    "xmrig" "kdevtmpfsi" "kinsing" "kthrotlds" "bioset" 
    "watchbog" "crypto" "minerd" "ccminer" "hash" "miner"
    "cryptonight" "xmr" "monero" "cpuminer" "ethminer"
    ".x" "ps-1" "systemd-login" ".rsync" ".sshd"
)

for proc in "${MALWARE_PROCESSES[@]}"; do
    if pgrep -i "$proc" > /dev/null; then
        echo -e "${RED}‚ö†Ô∏è  Matando proceso: $proc${NC}"
        pkill -9 -i "$proc" 2>/dev/null || true
        echo -e "${GREEN}‚úì $proc eliminado${NC}"
    fi
done

# Matar procesos ejecut√°ndose desde ubicaciones temporales
echo -e "${YELLOW}Eliminando procesos desde ubicaciones temporales...${NC}"
for pid in $(lsof +D /tmp 2>/dev/null | awk 'NR>1 {print $2}' | sort -u); do
    echo -e "${RED}‚ö†Ô∏è  Matando PID $pid desde /tmp${NC}"
    kill -9 "$pid" 2>/dev/null || true
done

for pid in $(lsof +D /var/tmp 2>/dev/null | awk 'NR>1 {print $2}' | sort -u); do
    echo -e "${RED}‚ö†Ô∏è  Matando PID $pid desde /var/tmp${NC}"
    kill -9 "$pid" 2>/dev/null || true
done

# 2. LIMPIAR LD_PRELOAD
echo -e "${BLUE}[2/15] Limpiando LD_PRELOAD...${NC}"
if [ -f /etc/ld.so.preload ]; then
    echo -e "${YELLOW}Backup de /etc/ld.so.preload${NC}"
    cp /etc/ld.so.preload /root/ld.so.preload.backup.$(date +%Y%m%d_%H%M%S)
    
    # Eliminar archivos referenciados
    while read -r lib; do
        if [ -f "$lib" ]; then
            echo -e "${RED}Eliminando: $lib${NC}"
            rm -f "$lib"
        fi
    done < /etc/ld.so.preload
    
    # Vaciar el archivo
    > /etc/ld.so.preload
    echo -e "${GREEN}‚úì LD_PRELOAD limpiado${NC}"
fi

# Tambi√©n buscar variantes
rm -f /usr/local/lib/libprocesshider.so 2>/dev/null || true
rm -f /usr/lib/libprocesshider.so 2>/dev/null || true
rm -f /lib/libprocesshider.so 2>/dev/null || true

# 3. LIMPIAR CRON JOBS MALICIOSOS
echo -e "${BLUE}[3/15] Limpiando cron jobs sospechosos...${NC}"

# Backup de todos los crontabs
mkdir -p /root/cron_backup_$(date +%Y%m%d_%H%M%S)
cp -r /var/spool/cron/ /root/cron_backup_$(date +%Y%m%d_%H%M%S)/ 2>/dev/null || true
cp /etc/crontab /root/cron_backup_$(date +%Y%m%d_%H%M%S)/ 2>/dev/null || true

# Eliminar cron jobs de root que contengan URLs sospechosas
echo -e "${YELLOW}Revisando crontab de root...${NC}"
crontab -l > /tmp/root_cron_original 2>/dev/null || true
if [ -f /tmp/root_cron_original ]; then
    # Filtrar l√≠neas sospechosas (URLs, wget, curl desde IPs)
    grep -v -E "(wget|curl|http://[0-9]|https://[0-9]|\.sh|\.py|/tmp/|/var/tmp/)" /tmp/root_cron_original > /tmp/root_cron_clean || true
    
    if [ -s /tmp/root_cron_clean ]; then
        crontab /tmp/root_cron_clean
        echo -e "${GREEN}‚úì Crontab de root limpiado${NC}"
    else
        crontab -r 2>/dev/null || true
        echo -e "${GREEN}‚úì Crontab de root eliminado (estaba completamente infectado)${NC}"
    fi
fi

# Revisar y limpiar /etc/cron.d/
echo -e "${YELLOW}Revisando /etc/cron.d/...${NC}"
if [ -d /etc/cron.d/ ]; then
    for cronfile in /etc/cron.d/*; do
        if [ -f "$cronfile" ]; then
            if grep -qE "(wget|curl.*http://[0-9]|\.sh|/tmp/)" "$cronfile"; then
                echo -e "${RED}‚ö†Ô∏è  Archivo sospechoso: $cronfile${NC}"
                cat "$cronfile"
                echo -e "${YELLOW}¬øEliminar? Haci√©ndolo...${NC}"
                rm -f "$cronfile"
            fi
        fi
    done
fi

# 4. ELIMINAR ARCHIVOS MALICIOSOS
echo -e "${BLUE}[4/15] Eliminando archivos maliciosos...${NC}"

# Directorios a limpiar completamente
echo -e "${YELLOW}Limpiando /tmp...${NC}"
find /tmp -type f -delete 2>/dev/null || rm -rf /tmp/* 2>/dev/null
echo -e "${GREEN}‚úì /tmp limpio${NC}"

echo -e "${YELLOW}Limpiando /var/tmp...${NC}"
find /var/tmp -type f -delete 2>/dev/null || rm -rf /var/tmp/* 2>/dev/null
echo -e "${GREEN}‚úì /var/tmp limpio${NC}"

echo -e "${YELLOW}Limpiando /dev/shm...${NC}"
find /dev/shm -type f -delete 2>/dev/null || rm -rf /dev/shm/* 2>/dev/null
echo -e "${GREEN}‚úì /dev/shm limpio${NC}"

# 5. BUSCAR Y ELIMINAR BINARIOS SOSPECHOSOS
echo -e "${BLUE}[5/15] Buscando binarios sospechosos...${NC}"

SUSPICIOUS_DIRS=(
    "/usr/bin"
    "/usr/sbin"
    "/usr/local/bin"
    "/usr/local/sbin"
    "/opt"
    "/var/lib"
)

for dir in "${SUSPICIOUS_DIRS[@]}"; do
    if [ -d "$dir" ]; then
        # Buscar archivos con nombres sospechosos
        find "$dir" -type f \( -name "*xmrig*" -o -name "*kinsing*" -o -name "*kdevtmpfsi*" -o -name ".*" \) -ls 2>/dev/null || true
    fi
done

# 6. ELIMINAR SERVICIOS SYSTEMD MALICIOSOS
echo -e "${BLUE}[6/15] Revisando servicios systemd...${NC}"

SUSPICIOUS_SERVICES=$(systemctl list-unit-files | grep -iE "(xmrig|kinsing|miner|crypto)" | awk '{print $1}')

if [ ! -z "$SUSPICIOUS_SERVICES" ]; then
    echo -e "${RED}Servicios sospechosos encontrados:${NC}"
    echo "$SUSPICIOUS_SERVICES"
    
    for service in $SUSPICIOUS_SERVICES; do
        echo -e "${YELLOW}Deshabilitando: $service${NC}"
        systemctl stop "$service" 2>/dev/null || true
        systemctl disable "$service" 2>/dev/null || true
    done
fi

# 7. LIMPIAR SCRIPTS DE INICIO
echo -e "${BLUE}[7/15] Revisando scripts de inicio...${NC}"

# Revisar rc.local
if [ -f /etc/rc.local ]; then
    echo -e "${YELLOW}Contenido de /etc/rc.local:${NC}"
    cat /etc/rc.local
    
    # Hacer backup
    cp /etc/rc.local /etc/rc.local.backup.$(date +%Y%m%d_%H%M%S)
    
    # Eliminar l√≠neas sospechosas
    grep -v -E "(wget|curl|http|\.sh|/tmp/)" /etc/rc.local > /etc/rc.local.clean || true
    mv /etc/rc.local.clean /etc/rc.local
    chmod +x /etc/rc.local
fi

# 8. CERRAR CONEXIONES SOSPECHOSAS
echo -e "${BLUE}[8/15] Cerrando conexiones de red sospechosas...${NC}"

# Puertos de miner√≠a conocidos: 3333, 4444, 5555, 7777, 8888, 14433, 14444, 45560
MINING_PORTS=(3333 4444 5555 7777 8888 14433 14444 45560)

for port in "${MINING_PORTS[@]}"; do
    PIDS=$(lsof -i ":$port" -t 2>/dev/null || true)
    if [ ! -z "$PIDS" ]; then
        echo -e "${RED}‚ö†Ô∏è  Matando procesos en puerto $port: $PIDS${NC}"
        kill -9 $PIDS 2>/dev/null || true
    fi
done

# 9. VERIFICAR Y LIMPIAR SSH
echo -e "${BLUE}[9/15] Verificando configuraci√≥n SSH...${NC}"

# Buscar claves SSH no autorizadas
echo -e "${YELLOW}Claves autorizadas en root:${NC}"
if [ -f /root/.ssh/authorized_keys ]; then
    cat /root/.ssh/authorized_keys
    echo ""
    echo -e "${YELLOW}Si ves claves no reconocidas, elim√≠nalas manualmente${NC}"
fi

# 10. BLOQUEAR IPS MALICIOSAS CONOCIDAS
echo -e "${BLUE}[10/15] Configurando firewall b√°sico...${NC}"

# Asegurarse de que SSH est√© permitido
if command -v ufw &> /dev/null; then
    ufw allow 22/tcp 2>/dev/null || true
    ufw allow 80/tcp 2>/dev/null || true
    ufw allow 443/tcp 2>/dev/null || true
    
    # Bloquear puertos de miner√≠a
    for port in "${MINING_PORTS[@]}"; do
        ufw deny "$port" 2>/dev/null || true
    done
fi

# 11. LIMPIAR HISTORIAL DE BASH
echo -e "${BLUE}[11/15] Limpiando historiales...${NC}"
> /root/.bash_history
history -c
echo -e "${GREEN}‚úì Historial limpiado${NC}"

# 12. VERIFICAR USERS SOSPECHOSOS
echo -e "${BLUE}[12/15] Verificando usuarios del sistema...${NC}"
echo -e "${YELLOW}Usuarios con shell de login:${NC}"
grep -v "/nologin\|/false" /etc/passwd

# 13. LIMPIAR CACHE DE PAQUETES
echo -e "${BLUE}[13/15] Limpiando cache de paquetes...${NC}"
if command -v apt-get &> /dev/null; then
    apt-get clean
elif command -v yum &> /dev/null; then
    yum clean all
fi

# 14. ACTUALIZAR SISTEMA
echo -e "${BLUE}[14/15] Actualizando lista de paquetes...${NC}"
if command -v apt-get &> /dev/null; then
    apt-get update -y
elif command -v yum &> /dev/null; then
    yum check-update
fi

# 15. VERIFICAR INTEGRIDAD
echo -e "${BLUE}[15/15] Verificaci√≥n final...${NC}"
echo -e "${YELLOW}Procesos con alto CPU:${NC}"
ps aux --sort=-%cpu | head -10

echo ""
echo -e "${GREEN}================================================${NC}"
echo -e "${GREEN}‚úÖ LIMPIEZA AVANZADA COMPLETADA${NC}"
echo ""
echo -e "${MAGENTA}ACCIONES CR√çTICAS PENDIENTES:${NC}"
echo "1. üîê Cambiar TODAS las contrase√±as (root, usuarios, SSH keys)"
echo "2. üîí Revisar /root/.ssh/authorized_keys y eliminar claves no autorizadas"
echo "3. üìä Monitorear uso de CPU durante las pr√≥ximas horas"
echo "4. üîÑ Ejecutar: sudo ./diagnose-vps.sh para verificar"
echo "5. üöÄ Si todo est√° limpio, ejecutar: sudo reboot"
echo "6. ‚ö†Ô∏è  Si el malware regresa, considerar REINSTALACI√ìN COMPLETA del VPS"
echo ""
echo -e "${YELLOW}DESPU√âS DEL REBOOT:${NC}"
echo "- Instalar y configurar fail2ban"
echo "- Configurar firewall adecuado (ufw/iptables)"
echo "- Desactivar login de root por SSH"
echo "- Usar autenticaci√≥n por clave SSH √∫nicamente"
echo ""
