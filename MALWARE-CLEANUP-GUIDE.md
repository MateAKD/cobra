# üõ°Ô∏è Gu√≠a de Limpieza y Protecci√≥n contra Malware en VPS

## üìã Resumen

Este conjunto de scripts te ayudar√° a:
1. **Diagnosticar** si tu VPS tiene malware activo
2. **Eliminar** el malware encontrado
3. **Proteger** el VPS contra futuras infecciones

## üö® S√çNTOMAS DE INFECCI√ìN

- ‚úó CPU al 100% sin raz√≥n aparente
- ‚úó VPS se cae o reinicia solo
- ‚úó Procesos desconocidos (xmrig, kinsing, hash, etc.)
- ‚úó Conexiones de red a IPs extra√±as
- ‚úó Aplicaci√≥n Next.js no funciona correctamente

## üìÅ Scripts Incluidos

1. **diagnose-vps.sh** - Diagn√≥stico completo del sistema
2. **cleanup-malware.sh** - Limpieza b√°sica de malware
3. **cleanup-malware-advanced.sh** - Limpieza avanzada (m√°s agresiva)
4. **secure-vps.sh** - Fortificaci√≥n del VPS

## üîç PASO 1: DIAGN√ìSTICO

Primero, necesitamos saber si realmente hay malware activo.

### Conectarse al VPS

```bash
ssh root@72.61.43.32
```

### Subir el script de diagn√≥stico

Desde tu m√°quina local (Windows):

```powershell
scp diagnose-vps.sh root@72.61.43.32:~/
```

### Ejecutar diagn√≥stico

En el VPS:

```bash
cd ~
chmod +x diagnose-vps.sh
sudo ./diagnose-vps.sh | tee diagnostico-$(date +%Y%m%d_%H%M%S).log
```

### üîé Qu√© buscar en los resultados:

#### ‚ö†Ô∏è SE√ëALES DE ALERTA CR√çTICAS:

1. **LD_PRELOAD EXISTE** - Si ves que `/etc/ld.so.preload` tiene contenido = MALWARE ACTIVO
2. **Procesos sospechosos** - Nombres como: xmrig, kinsing, kdevtmpfsi, hash, miner, crypto
3. **Procesos desde /tmp** - Cualquier proceso ejecut√°ndose desde /tmp, /var/tmp, /dev/shm
4. **CPU >80%** - Procesos usando mucha CPU sin raz√≥n
5. **Cron jobs raros** - Comandos con wget, curl, URLs de IPs
6. **Conexiones extra√±as** - Conexiones a IPs desconocidas en puertos raros (3333, 4444, etc.)

## üßπ PASO 2: LIMPIEZA

### Opci√≥n A: Limpieza B√°sica (Recomendada primero)

```bash
# Subir el script
# Desde Windows PowerShell:
scp cleanup-malware.sh root@72.61.43.32:~/

# En el VPS:
chmod +x cleanup-malware.sh
sudo ./cleanup-malware.sh
```

### Opci√≥n B: Limpieza Avanzada (Si la b√°sica no funciona)

**‚ö†Ô∏è ADVERTENCIA:** Este script es m√°s agresivo y puede matar procesos leg√≠timos.

```bash
# Subir el script
# Desde Windows PowerShell:
scp cleanup-malware-advanced.sh root@72.61.43.32:~/

# En el VPS:
chmod +x cleanup-malware-advanced.sh
sudo ./cleanup-malware-advanced.sh
```

### Despu√©s de la limpieza:

```bash
# Ejecutar diagn√≥stico nuevamente
sudo ./diagnose-vps.sh

# Si todo se ve limpio, reiniciar
sudo reboot
```

## üîê PASO 3: FORTIFICACI√ìN

Despu√©s de limpiar el malware, DEBES proteger el VPS para evitar reinfecci√≥n.

```bash
# Subir el script de seguridad
# Desde Windows PowerShell:
scp secure-vps.sh root@72.61.43.32:~/

# En el VPS:
chmod +x secure-vps.sh
sudo ./secure-vps.sh
```

Este script instalar√° y configurar√°:
- ‚úì **fail2ban** - Bloquea IPs que intentan ataques
- ‚úì **UFW Firewall** - Bloquea puertos de miner√≠a
- ‚úì **Protecci√≥n LD_PRELOAD** - Hace inmutable el archivo
- ‚úì **SSH reforzado** - Solo login con clave
- ‚úì **rkhunter** - Detector de rootkits
- ‚úì **chkrootkit** - Otro detector de rootkits
- ‚úì **Monitoreo autom√°tico** - Verifica cada 30 min
- ‚úì **Reporte diario** - Resumen de seguridad

## üîÑ PASO 4: VERIFICACI√ìN POST-LIMPIEZA

### Esperar 1-2 horas y verificar:

```bash
# Ver uso actual de CPU
top

# Ver procesos del sistema
ps aux --sort=-%cpu | head -20

# Verificar LD_PRELOAD
cat /etc/ld.so.preload  # Debe estar vac√≠o

# Ver conexiones activas
sudo netstat -tunap | grep ESTABLISHED

# Ver logs de monitoreo
sudo tail -f /var/log/malware-monitor.log
```

### Si el CPU se mantiene normal (<20%):
‚úÖ **√âXITO** - El malware fue eliminado

### Si el CPU vuelve a subir al 100%:
‚ö†Ô∏è **REINFECCI√ìN** - El malware tiene persistencia m√°s profunda

## ‚ùå PLAN B: Si el malware regresa

Si despu√©s de ejecutar todos los scripts el malware sigue regresando:

### Opci√≥n 1: Reinstalaci√≥n Completa (RECOMENDADO)

```bash
# 1. Hacer backup de la aplicaci√≥n
cd ~/Cobra\ 2.0
tar -czf ~/cobra-backup-$(date +%Y%m%d).tar.gz .

# 2. Descargar el backup a tu m√°quina local
# Desde Windows PowerShell:
scp root@72.61.43.32:~/cobra-backup-*.tar.gz ./

# 3. Solicitar reinstalaci√≥n del VPS a tu proveedor
# 4. Despu√©s de la reinstalaci√≥n, subir el backup
# 5. Seguir PASO 3 (Fortificaci√≥n) inmediatamente
```

### Opci√≥n 2: Investigaci√≥n Profunda

Si no puedes reinstalar, necesitas encontrar el vector de infecci√≥n:

```bash
# Buscar archivos modificados recientemente
find / -type f -mtime -1 -ls 2>/dev/null | grep -v "/proc\|/sys"

# Ver todos los cron jobs del sistema
for user in $(cut -f1 -d: /etc/passwd); do 
    echo "=== $user ==="; 
    crontab -u $user -l 2>/dev/null; 
done

# Buscar scripts de inicio
ls -la /etc/init.d/
cat /etc/rc.local
systemctl list-unit-files --state=enabled

# Verificar claves SSH no autorizadas
cat /root/.ssh/authorized_keys
```

## üîí MEDIDAS DE SEGURIDAD PREVENTIVAS

### 1. Cambiar TODAS las contrase√±as

```bash
# Cambiar contrase√±a de root
passwd

# Si tienes otros usuarios
passwd nombre_usuario
```

### 2. Configurar SSH con clave (NO contrase√±a)

```bash
# En tu m√°quina Windows (PowerShell):
# Generar clave SSH (si no tienes)
ssh-keygen -t ed25519 -C "tu_email@example.com"

# Copiar la clave al VPS
type $env:USERPROFILE\.ssh\id_ed25519.pub | ssh root@72.61.43.32 "cat >> ~/.ssh/authorized_keys"

# En el VPS, deshabilitar login por contrase√±a:
sudo nano /etc/ssh/sshd_config
# Cambiar: PasswordAuthentication no
sudo systemctl restart sshd
```

### 3. Mantener el sistema actualizado

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

### 4. Monitorear regularmente

```bash
# Configurar alerta por email cuando hay alto CPU
# Revisar logs diarios: /var/log/daily-security-*.log
# Ejecutar diagn√≥stico semanalmente
```

## üìä COMANDOS √öTILES PARA MONITOREO

```bash
# Ver uso de CPU en tiempo real
htop  # o: top

# Ver procesos con m√°s CPU
ps aux --sort=-%cpu | head -10

# Ver conexiones de red
sudo netstat -tunap

# Ver intentos de login fallidos
sudo grep "Failed password" /var/log/auth.log | tail -20

# Ver status de fail2ban
sudo fail2ban-client status sshd

# Ver reglas de firewall
sudo ufw status verbose

# Escanear con rkhunter
sudo rkhunter --check --skip-keypress

# Escanear con chkrootkit
sudo chkrootkit

# Ver logs de tu aplicaci√≥n Next.js
pm2 logs

# Ver uso de recursos de PM2
pm2 monit
```

## üÜò CONTACTOS Y RECURSOS

### Si necesitas ayuda adicional:

1. **Logs del sistema**: `/var/log/syslog` o `/var/log/messages`
2. **Logs de autenticaci√≥n**: `/var/log/auth.log`
3. **Logs de malware**: `/var/log/malware-monitor.log`
4. **Reportes diarios**: `/var/log/daily-security-*.log`

### Comunidades de ayuda:

- r/sysadmin
- r/linuxadmin
- Stack Overflow
- Linux Security subreddits

## ‚úÖ CHECKLIST FINAL

Despu√©s de completar TODOS los pasos:

- [ ] Diagn√≥stico ejecutado y revisado
- [ ] Limpieza ejecutada (b√°sica o avanzada)
- [ ] VPS reiniciado
- [ ] Diagn√≥stico post-limpieza ejecutado
- [ ] Fortificaci√≥n completada
- [ ] Todas las contrase√±as cambiadas
- [ ] SSH configurado con autenticaci√≥n por clave
- [ ] fail2ban instalado y activo
- [ ] Firewall (UFW) activo
- [ ] Monitoreo autom√°tico configurado
- [ ] CPU se mantiene <20% por al menos 2 horas
- [ ] Aplicaci√≥n Next.js funciona correctamente
- [ ] Conexi√≥n a MongoDB Atlas OK
- [ ] Website cobramenu.com funcional

## üéØ OBJETIVO FINAL

**VPS estable, seguro y sin malware**, ejecutando la aplicaci√≥n Next.js correctamente en `cobramenu.com`

---

**Creado:** Diciembre 2025  
**Versi√≥n:** 2.0 - Avanzada  
**Para:** VPS en 72.61.43.32
